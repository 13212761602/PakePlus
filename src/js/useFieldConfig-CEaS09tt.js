var R=Object.defineProperty;var z=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var T=(d,n,t)=>n in d?R(d,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[n]=t,J=(d,n)=>{for(var t in n||(n={}))U.call(n,t)&&T(d,t,n[t]);if(z)for(var t of z(n))W.call(n,t)&&T(d,t,n[t]);return d};var h=(d,n,t)=>new Promise((y,s)=>{var l=r=>{try{m(t.next(r))}catch(b){s(b)}},i=r=>{try{m(t.throw(r))}catch(b){s(b)}},m=r=>r.done?y(r.value):Promise.resolve(r.value).then(l,i);m((t=t.apply(d,n)).next())});import{au as x,at as q,$ as G,an as M}from"./bootstrap-CbEyMBZc.js";import{d as H}from"./vuedraggable.umd-Cwsj9bYW.js";import{g as j,s as K}from"./vxe-table-5UTMlFMN.js";import P from"./index-Yd03BW_o.js";import Q from"./index-1qAxlhJj.js";import{d as X,p as k,v as Y,h as $,o as V,w as p,W as Z,j as g,a as N,b as u,k as C,t as I,c as ee,F as ae,O as le}from"../jse/index-index-CKHiV3bJ.js";import{u as ie}from"./use-modal-BtBQhM0d.js";const oe={class:"flex h-[400px]"},te={class:"w-1/2 overflow-y-auto border-r pr-4"},se={class:"mb-4 flex justify-between"},ne={class:"text-gray-500"},de={class:"grid grid-cols-2 gap-2"},re={class:"w-1/2 overflow-y-auto pl-4"},fe={class:"flex cursor-move items-center gap-2 border-b px-2 py-1"},Ce=X({__name:"field-config-modal",props:{tableId:{},schema:{}},emits:["updateFieldConfig"],setup(d,{emit:n}){const t=d,y=n,s=k([]),l=k([]),i=k(!1),m=k(!1);function r(){s.value=t.schema.map(a=>({label:typeof a.label=="string"?a.label:a.fieldName,fieldName:a.fieldName}))}function b(){return h(this,null,function*(){i.value=!0;try{const a=yield j(t.tableId);if(a!=null&&a.formConfigData){const e=JSON.parse(a.formConfigData);let o=[],F={};Array.isArray(e)?(o=e,s.value.forEach(v=>{F[v.fieldName]=o.includes(v.fieldName)})):e&&(o=e.order||[],F=e.fields||{});const E=o.filter(v=>s.value.some(L=>L.fieldName===v)&&F[v]===!0);s.value.forEach(v=>{!E.includes(v.fieldName)&&F[v.fieldName]===!0&&E.push(v.fieldName)}),l.value=E.map(v=>({fieldName:v}))}else l.value=s.value.map(e=>({fieldName:e.fieldName}))}catch(a){console.error("加载字段配置失败:",a),M.error("加载字段配置失败"),l.value=s.value.map(e=>({fieldName:e.fieldName}))}finally{i.value=!1,m.value=!0}})}function c(){return h(this,null,function*(){i.value=!0;try{const a=l.value.map(o=>o.fieldName),e={};s.value.forEach(o=>{e[o.fieldName]=a.includes(o.fieldName)}),yield K({tableId:t.tableId,formConfigData:JSON.stringify({order:a,fields:e})}),y("updateFieldConfig",e),B.close()}catch(a){console.error("保存字段配置失败:",a),M.error("保存字段配置失败")}finally{i.value=!1}})}function f(a){const e=l.value.findIndex(o=>o.fieldName===a);e===-1?l.value.push({fieldName:a}):l.value.splice(e,1)}function O(a){return l.value.some(e=>e.fieldName===a)}function A(){l.value=s.value.map(a=>({fieldName:a.fieldName}))}function _(){l.value=[]}function D(){const a=new Set(l.value.map(e=>e.fieldName));l.value=s.value.filter(e=>!a.has(e.fieldName)).map(e=>({fieldName:e.fieldName}))}function w(a){const e=s.value.find(o=>o.fieldName===a);return e?e.label:a}const[S,B]=ie({onOpened:()=>h(null,null,function*(){m.value=!1,yield b()}),onClosed:()=>{m.value=!1}});return Y(()=>{r()}),(a,e)=>(V(),$(u(S),{title:u(G)("过滤条件设置"),class:"w-[800px]",loading:i.value},{footer:p(()=>[N(u(x),{onClick:u(B).close,disabled:i.value},{default:p(()=>e[7]||(e[7]=[C("取消")])),_:1,__:[7]},8,["onClick","disabled"]),N(u(x),{type:"primary",onClick:c,loading:i.value},{default:p(()=>e[8]||(e[8]=[C(" 确定 ")])),_:1,__:[8]},8,["loading"])]),default:p(()=>[Z(g("div",oe,[g("div",te,[g("div",se,[N(u(P),null,{default:p(()=>[N(u(x),{size:"small",onClick:A,disabled:i.value},{default:p(()=>e[1]||(e[1]=[C(" 全选 ")])),_:1,__:[1]},8,["disabled"]),N(u(x),{size:"small",onClick:_,disabled:i.value},{default:p(()=>e[2]||(e[2]=[C(" 清空 ")])),_:1,__:[2]},8,["disabled"]),N(u(x),{size:"small",onClick:D,disabled:i.value},{default:p(()=>e[3]||(e[3]=[C(" 反选 ")])),_:1,__:[3]},8,["disabled"])]),_:1}),g("div",ne," 已选择 "+I(l.value.length)+" / "+I(s.value.length)+" 个字段 ",1)]),g("div",de,[(V(!0),ee(ae,null,le(s.value,o=>(V(),$(u(Q),{key:o.fieldName,checked:O(o.fieldName),onChange:()=>f(o.fieldName),disabled:i.value},{default:p(()=>[C(I(o.label),1)]),_:2},1032,["checked","onChange","disabled"]))),128))])]),g("div",re,[e[6]||(e[6]=g("div",{class:"mb-2 font-bold"},"当前选中字段（可拖拽排序）",-1)),N(u(H),{modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=o=>l.value=o),"item-key":"fieldName",animation:200,disabled:i.value},{item:p(({element:o})=>[g("div",fe,[e[5]||(e[5]=g("span",{class:"text-gray-400"},"⋮⋮",-1)),g("span",null,I(w(o.fieldName)),1),N(u(x),{size:"small",type:"link",onClick:F=>f(o.fieldName),disabled:i.value},{default:p(()=>e[4]||(e[4]=[C(" 移除 ")])),_:2,__:[4]},1032,["onClick","disabled"])])]),_:1},8,["modelValue","disabled"])])],512),[[q,m.value]])]),_:1},8,["title","loading"]))}});function ye(d){const{tableId:n,getOriginalSchema:t,formOptions:y,tableApi:s}=d,l=k({}),i=k(t());function m(){return h(this,null,function*(){i.value=t();try{const c=yield j(n);if(c!=null&&c.formConfigData){const f=JSON.parse(c.formConfigData);if(f){const O=f.order||[],A=f.fields||{};i.value.forEach(_=>{l.value[_.fieldName]=A[_.fieldName]!==!1}),i.value.sort((_,D)=>{const w=O.indexOf(_.fieldName),S=O.indexOf(D.fieldName);return w!==-1&&S!==-1?w-S:w!==-1?-1:S!==-1?1:0})}}else i.value.forEach(f=>{l.value[f.fieldName]=!0})}catch(c){console.error("加载字段配置失败",c),i.value.forEach(f=>{l.value[f.fieldName]=!0})}r()})}function r(){const c=i.value.filter(f=>l.value[f.fieldName]!==!1);y.schema=[...c],s&&s.formApi&&(s.formApi.updateSchema(c),s.setState({formOptions:J({},y)}))}function b(){return h(this,null,function*(){yield m()})}return{fieldConfigState:l,originalSchema:i,initFormConfig:m,applyConfigToForm:r,updateFieldConfig:b}}export{Ce as _,ye as u};
